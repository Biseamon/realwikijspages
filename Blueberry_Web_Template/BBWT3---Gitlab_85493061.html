<!--
title: BBWT3---Gitlab_85493061
description: 
published: true
date: 2020-12-01T16:01:38.698Z
tags: 
editor: undefined
dateCreated: 2020-11-27T11:04:31.128Z
-->

<!DOCTYPE html>
<html>
    <head>
        <title>Blueberry Group : BBWT3 - Gitlab</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">Blueberry Group</a></span>
                            </li>
                                                    <li>
                                <span><a href="Blueberry-Web-Template_85492520.html">Blueberry Web Template</a></span>
                            </li>
                                                    <li>
                                <span><a href="BBWT3_85492530.html">BBWT3</a></span>
                            </li>
                                                    <li>
                                <span><a href="BBWT3---Build-Process-and-CI_85493059.html">BBWT3 - Build Process and CI</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            Blueberry Group : BBWT3 - Gitlab
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
        
    
        
        
            Created by <span class='author'> Jason Cozza</span> on Sep 21, 2020
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <h1 id="BBWT3-Gitlab-Overview">Overview</h1><p>GitLab is a service that gives access to git repositories. It allows for centralisation of source code and helps to manage the software development life cycle. It allows multiple developers to work on different aspects of the code, create and edit new projects and then merge it into existing ones. There are multiple hosting options, Blueberry consultants uses the free self-hosting community edition; to access you can click <a class="external-link" href="https://gitlab.bbconsult.co.uk/users/sign_in" rel="nofollow">here</a>.</p><h1 id="BBWT3-Gitlab-Advantages">Advantages</h1><ul><li>Free and open source.</li><li>Different hosting options.</li><li>GUI interface.</li><li>Protected branches - meaning only users with high level permissions are able to push or delete code in a branch.</li><li>Different authentication levels.</li><li>Milestones for groups not just individual developers.</li><li>Issue tracking.</li><li>Work in progress labelling - letting other developers know that the code isn't completed, so that it doesn't end up getting merged into a branch.</li></ul><h1 id="BBWT3-Gitlab-GettingStartedwithGitLab">Getting Started with GitLab</h1><ol><li>First go <a class="external-link" href="https://gitlab.bbconsult.co.uk/users/sign_in" rel="nofollow">here</a> to access the GitLab login page.</li><li>Login using your LDAP credentials (this will usually be your initials along with your standard blueberry password) Note: if you are unable to login make sure you have been added to a GitLab project - contact a sysadmin in this instance.</li><li>In the top right hand corner you will see an icon, click on this.</li><li>In the drop down menu click on &quot;Settings&quot;.</li><li>In the far left menu navigate to and click on &quot;Account&quot;.</li><li>In the page that loads click on &quot;Manage two-factor authentication&quot; (this needs to be set in order to clone git repositories).</li><li>Enable two-factor authentication following the on screen instructions and using the Google &quot;Authenticator&quot; app (or similar).</li><li>You should now be ready to set up your<a href="https://wiki.bbconsult.co.uk/pages/viewpage.action?pageId=65077466" rel="nofollow"> Development Environment</a> and begin contributing.</li></ol><h1 id="BBWT3-Gitlab-HowItIsUsedinBBWT3">How It Is Used in BBWT3</h1><p>For BBWT3, we're using GitLab – an open-source version of GitHub which includes a strong auto-build / auto-deploy solution.</p><p>Ideally, long-running BBWT2 projects should also move to GitLab too. We can’t easily move BBWT2 code to BBWT3, but we can take advantage <br/>of the new auto-build and auto-deploy - and save time managing Jenkins.</p><p>There’s a method to import SVN into GitLab source control. But we need to have an auto-build in place first so we can build/deploy</p><p>Our first BBWT3 project was VME. This uses ASP.NET Core on Linux, Elastic Load Balancer, Docker within Elastic Container Service and <br/>Aurora / MySQL. This is a technology stack which is intended for systems which we expect will scale to a large number of users. This <br/>stack isn’t sensible for smaller projects.</p><p><br/>We need to be careful to avoid supporting too many different technology stacks – it just makes life complicated.</p><p>This is our target list:</p><p><br/></p><div class="table-wrap"><table class="relative-table confluenceTable" style="width: 1032.0px;"><colgroup><col style="width: 0.0px;"/><col style="width: 0.0px;"/><col style="width: 0.0px;"/><col style="width: 0.0px;"/><col style="width: 0.0px;"/></colgroup><thead><tr><th class="confluenceTh"><br/></th><th class="confluenceTh"><p>Web</p></th><th class="confluenceTh"><p>DB</p></th><th colspan="1" class="confluenceTh"><p>Notes</p></th><th colspan="1" class="confluenceTh"><p>CI Deployment Process</p></th></tr></thead><tbody><tr><td class="confluenceTd"><strong>Windows Small Server Standalone</strong></td><td class="confluenceTd">Windows 2016 Server</td><td class="confluenceTd">MS SQL Express 2017</td><td colspan="1" class="confluenceTd">As BBWT2, Web and SQL on same machine mostly for testing.</td><td colspan="1" class="confluenceTd">CI launches Docker Image to do the build, which creates ZIP which is then installed on target server.</td></tr><tr><td colspan="1" class="confluenceTd"><strong>Linux Small Server Standalone</strong></td><td colspan="1" class="confluenceTd">Linux Server</td><td colspan="1" class="confluenceTd">MySQL on Web Server</td><td colspan="1" class="confluenceTd">Keep it simple, and similar to Windows Small Server Standalone.</td><td colspan="1" class="confluenceTd">CI launches Docker Image to do the build.</td></tr><tr><td class="confluenceTd"><strong>Windows Load Balanced</strong></td><td class="confluenceTd">Elastic Beanstalk /<br/>Multiple Windows 2016 Servers</td><td class="confluenceTd">MS SQL Server,<br/>Separate Instance</td><td colspan="1" class="confluenceTd">First one is HBS, allows availability/ redundancy by adding more Windows Servers.</td><td colspan="1" class="confluenceTd">CI launches Docker Image to do the build, which creates ZIP which is then installed on target server by EB.</td></tr><tr><td colspan="1" class="confluenceTd"><strong>Linux Load Balanced</strong></td><td colspan="1" class="confluenceTd">ECS running Multiple Containers</td><td colspan="1" class="confluenceTd">Aurora MySQL</td><td colspan="1" class="confluenceTd">This is the same as VME.</td><td colspan="1" class="confluenceTd">CI launches Docker Image to do the build, and image is then deployed to ECS.</td></tr><tr><td colspan="1" class="confluenceTd"><p><strong>Windows Small Server Shared</strong><br/>(mostly for testing)</p></td><td colspan="1" class="confluenceTd">Windows 2016 Server</td><td colspan="1" class="confluenceTd">MS SQL Server,<br/>Separate Instance</td><td colspan="1" class="confluenceTd">To save money, we put multiple test systems onto a single server. We did this for BBWT2, and should do it for BBWT3 when we have enough test systems.</td><td colspan="1" class="confluenceTd">CI launches Docker Image to do the build, which creates ZIP which is then installed on target server - CI must put in right IIS folder.</td></tr><tr><td colspan="1" class="confluenceTd"><strong>Linux Small Server Shared</strong> (mostly for testing)</td><td colspan="1" class="confluenceTd">ECS running Multiple Containers</td><td colspan="1" class="confluenceTd">Aurora MySQL</td><td colspan="1" class="confluenceTd">To save money, we could use this for multiple test systems, each of which has just one container. We still need to have a load balancer to route connections.</td><td colspan="1" class="confluenceTd">CI launches Docker Image to do the build, and image is then deployed to ECS.</td></tr></tbody></table></div><p><br/></p><p>Notes</p><ol><li>In general, I'm expecting to use Linux for most of our deployments.</li><li>For now, we ignore the Small Server Shared configurations - we won't save money until we have multiple test system. Note that we could do Linux Shared in the same way as Windows<br/>Shared - i.e. multiple systems on one server, and this is probably more efficient than using Docker, which requires xGB ram per container. Long term, we should be investing in Serverless<br/>computing to reduce the overload of managing servers.</li><li>We're applying a rule that we use Windows and MS SQL, and Linux and MySQL - this isn't required, it just reduces the number of configurations. If someone really wants a mix, OK.</li><li>Aurora is only available for MySQL and PostgreSQL, not Linux. It has much better backup and redundancy support than stand-alone MySQL, and is probably faster. For stand-alone scenarios<br/>above, I'm suggesting we keep local MySQL, but this could be changed. Local MySQL is a bit cheaper though, if web-server isn't loaded. Note that Aurora works in unit of a DB instance with <br/>multiple DBs, and the unit of backup is the whole instance. This MAY make it less useful to share Aurora DB instances between projects.</li><li>We should have Terraform scripts for each of these, which can be used to create a new server as required.</li></ol><h1 id="BBWT3-Gitlab-SendingcommitdatatoPTS">Sending commit data to PTS</h1><p>Repository event data can be sent back to PTS using a webhook. For now, we're just sending back push events. To set this up for your Web Template 3 project, navigate to <strong>Settings → Integrations</strong> in the project, and add a new webhook with the following values:</p><ul><li>URL: <a class="external-link" href="https://ptsb.bbconsult.co.uk/api/git/push" rel="nofollow">https://ptsb.bbconsult.co.uk/api/git/push</a></li><li>Trigger: Push events</li></ul><h1 id="BBWT3-Gitlab-SendingDataBacktoGitLab">Sending Data Back to GitLab</h1><h2 id="BBWT3-Gitlab-Introduction">Introduction</h2><p>One of the visions for BBWT3 is to enable customers or PMs / Testers to make changes to a number of areas of the website without having to go back to developers to update the code.  In general, these changes will be made by the customer during the testing phase of development and so need to find themselves back into source control for when the site goes live.  The changes will be submitted to GitLab as a merge request which a PM will need to accept.</p><p>An example of where this would be required is for the tool-tip functionality.  We want users to be able to edit the tool-tips themselves and for those changes to be updated in the source control.</p><p>The updates made will be recorded in a JSON file.  This file will need to be updated in the BBWT3 local database (so that other users can immediately see their changes), and also sent to GitLab so that source control is updated.</p><p>The JSON file lives in source control and is versioned, but we also want to have a copy in the DB so that IF someone edits the JSON, then other browser clients can get that JSON without needing to wait for the app to be rebuilt.  For the cases where we have used this feature to date, we have just been concerned about data and not code.  In the future we might need to look at rebuilding the code, in this case there will be other options:</p><ol><li><p>We just don't bother.  If only one person is editing, they can check it on their own PC.  Other users can wait for rebuild.</p></li><li><p>We build a CI hook so that if we change the JSON file, it automatically triggers a rebuild.</p></li><li><p>We build a CI hook that just re-runs web-pack on any change - we don't recompile the code, but we update the web-pack zip, so clients will re-download it.</p></li><li><p>We don't put in the DB, but we allow a JS client to put it in the DB.  Clients get their main copy from web-pack, but if there is a new version in the DB they take it.  On rebuild we clear the DB.</p></li></ol><h2 id="BBWT3-Gitlab-Infrastructure">Infrastructure</h2><p>In order to allow a BBWT3 site to send data back into GitLab securely, without needing to include in the site source the GitLab keys, we are going to create the following infrastructure:</p><p><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image confluence-content-image-border" height="400" width="760" src="attachments/85493061/85493062.png" data-image-src="attachments/85493061/85493062.png" data-unresolved-comment-count="0" data-linked-resource-id="85493062" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="GitLab WebService.PNG" data-base-url="https://wiki.bbconsult.co.uk" data-linked-resource-content-type="image/png" data-linked-resource-container-id="85493061" data-linked-resource-container-version="1"></span></span></p><h2 id="BBWT3-Gitlab-FunctionsSupported">Functions Supported</h2><p>At present the following features have been implemented using this push to GitLab mechanism:</p><ul><li>TOOLTIP.</li><li>DBDOCUMENT.</li><li>Static Pages (e.g. privacy policy).</li><li>Menu Structure.</li><li>Email Templates.</li></ul><p>We are also looking at:</p><ul><li>VALIDATION:<br/>Control validation rules - this is more complicated and requires more thought, it will require more stringent validation rules and will probably need different storage mechanisms.  In principle it will work the same way as tooltips, but will require more security checks.</li></ul><h2 id="BBWT3-Gitlab-JSONFile">JSON File</h2><p>The changes the user makes will be stored in a JSON file.  This JSON file contains all the information i.e. it is not incremental but contains all the information in one file.</p><p>The file will be versioned in GitLab as a project file.  When the site is started, the contents of that file will be written to the BBWT3 server database.</p><p>As the user makes changes to the data (e.g. edits a tool-tip) the data will be stored in the browser until the user is ready to submit their changes.  There is some concern that if the user makes a lot of changes they could loose data if a browser crash occurs, to mitigate against that tool-tip edits will only be allowed for a single page at a time before submitting to the server is required.  Future enhancements could be to:</p><ul><li>Save the data in browser local storage in case of a browser cache (we do this already for order creation in VME).</li><li>Save the data in a holding table in the database.</li></ul><p><br/></p><p>The JSON file will include a header of who made the last change and the datetime stamp of when the file was updated.  When the file is written to the database (table metadata in the BBWT3 database), it will also compare the datetime stamp to the LastUpdated field. </p><p>If the LastUpdated field is later than or equal to the current datetime then it will:</p><ul><li>Update the LastUpdated to be the value in the JSON file.</li><li>Update the JSON file to be the latest.</li><li>Set the IsLocked field on the record= false.</li></ul><p>If the value in the JSON file is earlier than the last updated value then it will:</p><ul><li>Set the IsLocked field on the record = true.</li></ul><p>The individual BBWT3 pages will check the value of the IsLocked field to see if more edits can be made.  If it is true then the pages will show a message saying there are pending changes and not allow the user to edit.</p><h2 id="BBWT3-Gitlab-Multi-UserIssues">Multi-User Issues</h2><p>Because changes are being recorded in a single JSON file, there is an issue when more than one person is editing the data at the same time (last person to save would overwrite all changes).  We are not going to block this from happening but will warn a user that other people are in admin mode.  So for example, with tool-tips, if one person clicks on tool-tip admin mode, we will record their username in a BBWT3 database table and warn anyone else who clicks on the tool-tip admin mode checkbox if other people are also in admin mode and that data might be lost.</p><h2 id="BBWT3-Gitlab-GitLab">GitLab</h2><p>The GitLab service will take the function passed to it and call GitLab to get the name of the branch to create or update.</p><p>Once the user has edited the data and committed to the server, the process will create a merge request for the PM to accept.  If Blueberry staff edit the data themselves then they will need to submit the changes for merging using the same branch name convention.  If this does not happen, then merge conflicts may occur and there is a danger that changes could be overwritten.  If a developer deletes a control off a page, then there is a danger that a merge request could end up adding the information back into the JSON File, but this should be safe - will just add not used information.  The PM will control the merging so will be aware of changes being made.</p><p>Each project in GitLab has a project ID.  We will change the CI so that this value gets compiled into the project in the same way we currently use the build pipeline for the build version number.</p><h2 id="BBWT3-Gitlab-ProcessComponents">Process Components</h2><h3 id="BBWT3-Gitlab-ClientAngularPage">Client Angular Page</h3><p>Every function will require a page in BBWT3 to allow users to administer the functionality.  The data edited will need to be sent to GitLab and so the page will need to work with a JSON file locally until the user is ready to submit their changes.  Clicking on the submit button will call a C# controller class as per normal MVC models.</p><h3 id="BBWT3-Gitlab-FunctionController">Function Controller</h3><p>There will be a controller class for the data being edited.  This will receive the JSON file from the Angular page and pass it on to C# Service code to validate and process it.  The service code will send the data to the local BBWT3  database (either as JSON blob, e.g. for tool-tip, or as field data e.g. for DBSchema) and also send the JSON file to the BBWT3_Gitlab AWS Gateway service.</p><p><br/></p><p>To call the BBWT3_Gitlab Service, the BBWT3 service code will read the:</p><ul><li>Project Name, Version and ID from the project fields (compiled in by GitLab CI).</li><li>Username of logged in user (will be added to check-in comment)  <span style="color: rgb(255,0,0);">Note that this is always tricky, as most customers and testers use &quot;admin@&quot;.  I'll email on a solution later.</span></li><li>GitLab Access key from Environment Variable on server.</li><li>Hard coded Function Name (e.g. TOOLTIP).</li></ul><h3 id="BBWT3-Gitlab-BBWT3_GitlabAmazonGatewayService">BBWT3_Gitlab Amazon Gateway Service</h3><p>We will need an Amazon Gateway service and associated Lambda function to be written.  This will need to:</p><ul><li>Create the branch name from the project name and the Function<ul><li>Function: TOOLTIP                        Branch Path: Feature/TOOLTIP</li><li>Function: DBDOCUMENT             Branch Path: Feature/DBDOCUMENT</li></ul></li></ul><ul><li>Call GitLab Branches API (<a class="external-link" href="https://docs.gitlab.com/ee/api/branches.html" rel="nofollow">https://docs.gitlab.com/ee/api/branches.html</a>) using the Project ID to see if the branch already exists.</li><li>If the branch already exists, then update that branch (GitLab will overlay the new changes on the file in the branch).</li><li>If the branch does not exist, create a new branch using received branch path (make it temporary so that it is automatically deleted after merge is accepted).</li><li>CallGitLab Commits API (<a class="external-link" href="https://docs.gitlab.com/ee/api/commits.html" rel="nofollow">https://docs.gitlab.com/ee/api/commits.html</a>) to commit file.  Location will be src\BBWT.Web\Filename. The checkin comments will detail the DateTime - username of the person making the change.</li><li>Call GitLab Merge requests API (<a class="external-link" href="https://docs.gitlab.com/ee/api/merge_requests.html" rel="nofollow">https://docs.gitlab.com/ee/api/merge_requests.html</a>) to create a new merge request for created branch.</li></ul><p><br/></p><p>The code will need to validate the JSON object passed to it.  It should ensure it does not contain HTML tags or Script tags.</p>
                    </div>

                                        <div class="pageSection group">
                        <div class="pageSectionHeader">
                            <h2 id="attachments" class="pageSectionTitle">Attachments:</h2>
                        </div>

                        <div class="greybox" align="left">
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/85493061/85493062.png">GitLab WebService.PNG</a> (image/png)
                                <br/>
                                                    </div>
                    </div>
                    
                 
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on Nov 27, 2020 10:56</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
