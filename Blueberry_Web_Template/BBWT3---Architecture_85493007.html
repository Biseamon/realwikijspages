<!DOCTYPE html>
<html>
    <head>
        <title>Blueberry Group : BBWT3 - Architecture</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">Blueberry Group</a></span>
                            </li>
                                                    <li>
                                <span><a href="Blueberry-Web-Template_85492520.html">Blueberry Web Template</a></span>
                            </li>
                                                    <li>
                                <span><a href="BBWT3_85492530.html">BBWT3</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            Blueberry Group : BBWT3 - Architecture
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
        
    
        
        
            Created by <span class='author'> Jason Cozza</span> on Sep 21, 2020
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <h1 id="BBWT3-Architecture-Overview">Overview</h1><p>This page outlines some of the architecture behind BBWT3, including example environments.</p><p><br/></p><p>BBWT3 relies on this software stack (non-exhaustive list):</p><ul><li>ASP.NET Core</li><li>Entity Framework Core</li><li>MySQL</li><li>MSSQL Server</li><li>Webpack</li><li>Angular 9.1 / TypeScript</li><li>PrimeNG</li><li>AWS</li><li>Azure</li><li>HangFire</li></ul><p>The source code’s solution uses Visual Studio 2019 and contains these projects that we should focus on:</p><ul><li><strong><strong>project\BBWT.Client</strong> - The front-end code. <br/></strong></li><li><strong><strong><strong>project</strong></strong>\BBWT.Data</strong> - models of data context, DTOs and their mapping profiles.</li><li><strong><strong><strong>project</strong></strong>\BBWT.Data.MySQL</strong> - DB schema migrations for MySQL.</li><li><strong><strong><strong>project</strong></strong>\BBWT.Data.SqlServer</strong> - DB schema migrations for MSSQL Server.</li><li><strong><strong><strong>project</strong></strong>\BBWT.InitialData</strong> - creates/updates all necessary initial DB records; initializes access rules for pages routes; initializes menu.</li><li><strong><strong><strong>project</strong></strong>\BBWT.Server</strong> - The back-end code. Handles clients requests via API controllers.</li><li><strong><strong><strong>project</strong></strong>\BBWT.Services</strong> -  the services layer; describes business logic; works with models/DTOs and data context.</li></ul><h3 id="BBWT3-Architecture-TechnicalArchitecture">Technical Architecture</h3><div class="table-wrap"><table class="confluenceTable"><colgroup><col/><col/><col/></colgroup><tbody><tr><td class="confluenceTd"><p style="text-align: center;"><span style="color: rgb(0,0,0);"><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image confluence-external-resource" height="60" width="60" src="https://lh4.googleusercontent.com/z3si5FoSDWNINBKwh0rEmTo1McnBPK9M2UkPjYD1TiFSTcjSTDx66Be3gxP5d25hCDdK8I9a8HcGufaH4dtzUKDMdbcbQRk9sfWHYfngljsklKB6SVjYnxRKbpAtJDzlKQA0tYo" data-image-src="https://lh4.googleusercontent.com/z3si5FoSDWNINBKwh0rEmTo1McnBPK9M2UkPjYD1TiFSTcjSTDx66Be3gxP5d25hCDdK8I9a8HcGufaH4dtzUKDMdbcbQRk9sfWHYfngljsklKB6SVjYnxRKbpAtJDzlKQA0tYo"></span></span></span></p></td><td class="confluenceTd"><p style="text-align: center;"><span style="color: rgb(0,0,0);"><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image confluence-external-resource" height="60" width="39" src="https://lh4.googleusercontent.com/Q3G8f6NlhXaBAckoqog97zj5bLMO0oSR7A87WwDUMfDXFn26VrJCD02Vstp0iAnaMQ8uK2Tras4pZUBzALB92SY3SWYOqaFHWQKxgOdmSB2ro7Bw8v42FP_lzMir4qIseOli4a0" data-image-src="https://lh4.googleusercontent.com/Q3G8f6NlhXaBAckoqog97zj5bLMO0oSR7A87WwDUMfDXFn26VrJCD02Vstp0iAnaMQ8uK2Tras4pZUBzALB92SY3SWYOqaFHWQKxgOdmSB2ro7Bw8v42FP_lzMir4qIseOli4a0"></span></span></span></p></td><td class="confluenceTd"><p style="text-align: center;"><span style="color: rgb(0,0,0);"><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image confluence-external-resource" height="57" width="49" src="https://lh3.googleusercontent.com/qo41D-pTV3tjkzxxMEidc3AE1d6p4NZcwuwrJwrRVSweTqaAM2vHVjErzsAHL3y6CoLrunjJQvgBeXxsWn9CGkxvUtPnLFa3oJuqJQCrHieCaK-QyqYeHvVDj2SKwn0hymVDcAM" data-image-src="https://lh3.googleusercontent.com/qo41D-pTV3tjkzxxMEidc3AE1d6p4NZcwuwrJwrRVSweTqaAM2vHVjErzsAHL3y6CoLrunjJQvgBeXxsWn9CGkxvUtPnLFa3oJuqJQCrHieCaK-QyqYeHvVDj2SKwn0hymVDcAM"></span></span></span></p></td></tr><tr><td rowspan="2" class="confluenceTd"><ul><li style="list-style-type: disc;"><p>Angular</p></li><li style="list-style-type: disc;"><p>PrimeNG</p></li><li style="list-style-type: disc;"><p>TypeScript</p></li></ul></td><td class="confluenceTd"><ul><li style="list-style-type: disc;"><p>C#</p></li><li style="list-style-type: disc;"><p>ASP.NET Core </p></li></ul><p style="margin-left: 36.0pt;"><span style="color: rgb(0,0,0);">(on Windows or Linux)</span></p></td><td class="confluenceTd"><ul><li style="list-style-type: disc;"><p>MySQL</p></li><li style="list-style-type: disc;"><p>Or MSSQL Server</p></li><li style="list-style-type: disc;"><p>Or Postgress</p></li><li style="list-style-type: disc;"><p>Or Amazon Aurora</p></li></ul></td></tr><tr><td class="confluenceTd"><p style="text-align: center;"><span style="color: rgb(51,51,153);">Middleware</span></p></td><td class="confluenceTd"><p style="text-align: center;"><span style="color: rgb(51,51,153);">Database</span></p></td></tr><tr><td class="confluenceTd"><p style="text-align: center;"><span style="color: rgb(255,102,0);"><strong>Client-side</strong></span></p></td><td colspan="2" class="confluenceTd"><p style="text-align: center;"><span style="color: rgb(51,51,153);"><strong>Server-side</strong></span></p></td></tr></tbody></table></div><h3 id="BBWT3-Architecture-CallSequenceofaClientRequest">Call Sequence of a Client Request</h3><p><span style="color: rgb(0,0,0);"><span class="confluence-embedded-file-wrapper"><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="attachments/85493007/85493008.png" data-image-src="attachments/85493007/85493008.png" data-unresolved-comment-count="0" data-linked-resource-id="85493008" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image2020-8-30_9-6-13.png" data-base-url="https://wiki.bbconsult.co.uk" data-linked-resource-content-type="image/png" data-linked-resource-container-id="85493007" data-linked-resource-container-version="1"></span></span><br/></span></p><p>In this figure, we can see how the different layers of the solution communicate with each other and with the exterior. The call sequence is the following:</p><ol><li>The client downloads all the static assets, including Angular, given by BBWT3.Client with the help of Webpack (this is done only once);</li><li>When the Angular app is started on the client, it starts to make REST HTTP calls to BBWT3.Server controllers;</li><li>The controller calls the service it needs to perform the demanded request;</li><li>The service asks EF to perform a database request (if needed);</li><li>EF performs the SQL requests (this is automatic);</li><li>The resulting data is retrieved (also automatic);</li><li>BBWT.Data gives back the resulting data as models to the service;</li><li>The service converts the model into a DTO and performs operations on it if needed;</li><li>The controller responds to the HTTP request with a JSON object containing the DTO.</li></ol><h1 id="BBWT3-Architecture-BlueberryWebTemplate3Environments">Blueberry Web Template 3 Environments</h1><p>Blueberry Web Template 3 is run on <a class="external-link" href="https://aws.amazon.com/elasticbeanstalk/" rel="nofollow">AWS Elastic Beanstalk</a>, with an environment per combination of branch/platform/database.</p><p>For BBWT3 specifically, the Aurora instance is shared between platforms and branches. As the run-time code is common between operating systems, there's no need to distinguish between these two at the database level. At the branch level, we can create separate catalogues within the Aurora instance. In this case, we have 'master' and 'test' catalogues in the instance.</p><p>As Elastic Beanstalk does not natively support RDS Aurora (i.e. you cannot bind a new or running Aurora instance to a Beanstalk environment) we need to manually specify access control within the appropriate security groups. An example of a security group structure which allows RDS access from two different Beanstalk groups is shown below.</p><p><br/></p><p><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image confluence-content-image-border" height="821" width="1246" src="attachments/85493007/85493009.png" data-image-src="attachments/85493007/85493009.png" data-unresolved-comment-count="0" data-linked-resource-id="85493009" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="Beanstalk RDS security groups.png" data-base-url="https://wiki.bbconsult.co.uk" data-linked-resource-content-type="image/png" data-linked-resource-container-id="85493007" data-linked-resource-container-version="1"></span></span></p><p><br/></p><p>The environments have been divided based on branch, platform, and database type. To make it easier for developers and sysadmins, the environments and URLs are constructed in this manner: <strong>branch-platform-database_type</strong>.</p><div class="table-wrap"><table class="confluenceTable"><colgroup><col/><col/><col/><col/></colgroup><tbody><tr><th class="confluenceTh">Branch</th><th class="confluenceTh">Platform</th><th class="confluenceTh">Database Type</th><th colspan="1" class="confluenceTh">URL</th></tr><tr><td class="confluenceTd">master</td><td class="confluenceTd">Windows</td><td style="text-align: center;" class="confluenceTd">SQL Server</td><td colspan="1" class="confluenceTd"><a class="external-link" href="https://bbwt3-master-windows-sqlserver.blueberrytest.com/" rel="nofollow">https://bbwt3-master-windows-sqlserver.blueberrytest.com</a></td></tr><tr><td class="confluenceTd">test</td><td class="confluenceTd">Windows</td><td style="text-align: center;" class="confluenceTd">SQL Server</td><td colspan="1" class="confluenceTd"><a class="external-link" href="https://bbwt3-test-windows-sqlserver.blueberrytest.com/" rel="nofollow">https://bbwt3-test-windows-sqlserver.blueberrytest.com</a></td></tr><tr><td class="highlight-green confluenceTd" data-highlight-colour="green"><span style="color: rgb(0,51,102);">master</span></td><td class="highlight-green confluenceTd" data-highlight-colour="green"><span style="color: rgb(0,51,102);">Windows</span></td><td class="highlight-green confluenceTd" data-highlight-colour="green" rowspan="4"><p><br/></p><p style="text-align: center;">Aurora</p><p style="text-align: center;">(shared instance with 'master' and 'test' catalogues)</p></td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green"><a class="external-link" href="https://bbwt3-master-windows-aurora.blueberrytest.com/" rel="nofollow">https://bbwt3-master-windows-aurora.blueberrytest.com</a></td></tr><tr><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green"><span style="color: rgb(0,51,102);">test</span></td><td class="highlight-green confluenceTd" colspan="1" data-highlight-colour="green">Windows</td><td class="highlight-green confluenceTd" data-highlight-colour="green"><a class="external-link" href="https://bbwt3-test-windows-aurora.blueberrytest.com/" rel="nofollow">https://bbwt3-test-windows-aurora.blueberrytest.com</a></td></tr><tr><td class="confluenceTd">master</td><td class="confluenceTd">Linux</td><td class="confluenceTd"><a class="external-link" href="https://bbwt3-master-linux-aurora.blueberrytest.com/" rel="nofollow">https://bbwt3-master-linux-aurora.blueberrytest.com</a></td></tr><tr><td class="confluenceTd">test</td><td class="confluenceTd">Linux</td><td class="confluenceTd"><a class="external-link" href="https://bbwt3-test-linux-aurora.blueberrytest.com/" rel="nofollow">https://bbwt3-test-linux-aurora.blueberrytest.com</a></td></tr></tbody></table></div><p>Green indicates active deployments.</p><p><br/></p><p>This is visualised as:</p><p><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image confluence-content-image-border" height="400" width="665" src="attachments/85493007/85493010.png" data-image-src="attachments/85493007/85493010.png" data-unresolved-comment-count="0" data-linked-resource-id="85493010" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="cloudcraft - BBWT3 deployment targets.png" data-base-url="https://wiki.bbconsult.co.uk" data-linked-resource-content-type="image/png" data-linked-resource-container-id="85493007" data-linked-resource-container-version="1"></span></span></p><h1 id="BBWT3-Architecture-Deploying">Deploying</h1><p>Deployment is handled by GitLab. Within the BBWT3 project on GitLab is a <a href="https://wiki.bbconsult.co.uk/display/BLUEB/GitLab+CI" rel="nofollow">CI file</a> which defines how the job should be built and deployed. The table above has been translated into CI jobs for GitLab to build and deploy to.</p><p>Deployment occurs on commits or merges to the <strong>master</strong> or <strong>test</strong> branches only, which then deploy on the appropriate beanstalk.</p>
                    </div>

                                        <div class="pageSection group">
                        <div class="pageSectionHeader">
                            <h2 id="attachments" class="pageSectionTitle">Attachments:</h2>
                        </div>

                        <div class="greybox" align="left">
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/85493007/85493008.png">image2020-8-30_9-6-13.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/85493007/85493009.png">Beanstalk RDS security groups.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/85493007/85493010.png">cloudcraft - BBWT3 deployment targets.png</a> (image/png)
                                <br/>
                                                    </div>
                    </div>
                    
                 
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on Nov 27, 2020 10:56</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
