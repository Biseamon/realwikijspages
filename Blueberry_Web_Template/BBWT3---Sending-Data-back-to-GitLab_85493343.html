<!--
title: BBWT3---Sending-Data-back-to-GitLab_85493343
description: 
published: true
date: 2020-12-01T16:48:55.515Z
tags: 
editor: undefined
dateCreated: 2020-11-27T11:06:39.437Z
-->

<!DOCTYPE html>
<html>
    <head>
        <title>Blueberry Group : BBWT3 - Sending Data back to GitLab</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">Blueberry Group</a></span>
                            </li>
                                                    <li>
                                <span><a href="Blueberry-Web-Template_85492520.html">Blueberry Web Template</a></span>
                            </li>
                                                    <li>
                                <span><a href="BBWT3_85492530.html">BBWT3</a></span>
                            </li>
                                                    <li>
                                <span><a href="BBWT3---Technical-Notes_85493335.html">BBWT3 - Technical Notes</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            Blueberry Group : BBWT3 - Sending Data back to GitLab
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
        
    
        
        
            Created by <span class='author'> Jason Cozza</span> on Sep 22, 2020
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <h2 id="BBWT3-SendingDatabacktoGitLab-Introduction">Introduction</h2><p>One of the visions for BBWT3 is to enable customers or PMs / Testers to make changes to a number of areas of the website without having to go back to developers to update the code.  In general, these changes will be made by the customer during the testing phase of development and so need to find themselves back into source control for when the site goes live.  The changes will be submitted to GitLab as a merge request which a PM will need to accept.</p><p>An example of where this would be required is for the tool-tip functionality.  We want users to be able to edit the tool-tips themselves and for those changes to be updated in the source control.</p><p>The updates made will be recorded in a JSON file.  This file will need to be updated in the BBWT3 local database (so that other users can immediately see their changes), and also sent to GitLab so that source control is updated.</p><p>The JSON file lives in source control and is versioned, but we also want to have a copy in the DB so that IF someone edits the JSON, then other browser clients can get that JSON without needing to wait for the app to be rebuilt.  For the cases where we have used this feature to date, we have just been concerned about data and not code.  In the future we might need to look at rebuilding the code, in this case there will be other options:</p><ol><li><p>We just don't bother.  If only one person is editing, they can check it on their own PC.  Other users can wait for rebuild.</p></li><li><p>We build a CI hook so that if we change the JSON file, it automatically triggers a rebuild</p></li><li><p>We build a CI hook that just re-runs web-pack on any change - we don't recompile the code, but we update the web-pack zip, so clients will re-download it</p></li><li><p>We don't put in the DB, but we allow a JS client to put it in the DB.  Clients get their main copy from web-pack, but if there is a new version in the DB they take it.  On rebuild we clear the DB</p></li></ol><h2 id="BBWT3-SendingDatabacktoGitLab-Infrastructure">Infrastructure</h2><p>In order to allow a BBWT3 site to send data back into GitLab securely, without needing to include in the site source the Gitlab keys, we are going to create the following infrastructure:</p><p><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image" height="400" src="attachments/85493343/85493344.png" data-image-src="attachments/85493343/85493344.png" data-unresolved-comment-count="0" data-linked-resource-id="85493344" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="GitLab WebService.PNG" data-base-url="https://wiki.bbconsult.co.uk" data-linked-resource-content-type="image/png" data-linked-resource-container-id="85493343" data-linked-resource-container-version="1"></span></span></p><h2 id="BBWT3-SendingDatabacktoGitLab-FunctionsSupported">Functions Supported</h2><p>At present the following features have been implemented using this push to GitLab mechanism:</p><ul><li>TOOLTIP</li><li>DBDOCUMENT</li><li>Static Pages (e.g. privacy policy)</li><li>Menu Structure</li><li>Email Templates</li></ul><p>We are also looking at:</p><ul><li>VALIDATION <br/>Control validation rules - this is more complicated and requires more thought, it will require more stringent validation rules and will probably need different storage mechanisms.  In principle it will work the same way as tooltips, but will require more security checks</li></ul><p><br/></p><h2 id="BBWT3-SendingDatabacktoGitLab-JSONFile">JSON File</h2><p>The changes the user makes will be stored in a JSON file.  This JSON file contains all the information i.e. it is not incremental but contains all the information in one file.</p><p>The file will be versioned in GitLab as a project file.  When the site is started, the contents of that file will be written to the BBWT3 server database.</p><p>As the user makes changes to the data (e.g. edits a tool-tip) the data will be stored in the browser until the user is ready to submit their changes.  There is some concern that if the user makes a lot of changes they could loose data if a browser crash occurs, to mitigate against that tool-tip edits will only be allowed for a single page at a time before submitting to the server is required.  Future enhancements could be to:</p><p><br/></p><ul><li>Save the data in browser local storage in case of a browser cache (we do this already for order creation in VME)</li><li>Save the data in a holding table in the database.</li></ul><p><br/></p><p>The JSON file will include a header of who made the last change and the datetime stamp of when the file was updated.  When the file is written to the database (table metadata in the BBWT3 database), it will also compare the datetime stamp to the LastUpdated field. </p><p>If the LastUpdated field is later than or equal to the current datetime then it will:</p><ul><li>Update the LastUpdated to be the value in the JSON file</li><li>Update the JSON file to be the latest</li><li>Set the IsLocked field on the record= false</li></ul><p>If the value in the JSON file is earlier than the last updated value then it will:</p><ul><li>Set the IsLocked field on the record = true</li></ul><p>The individual BBWT3 pages will check the value of the IsLocked field to see if more edits can be made.  If it is true then the pages will show a message saying there are pending changes and not allow the user to edit.</p><p><br/></p><h2 id="BBWT3-SendingDatabacktoGitLab-Multi-UserIssues">Multi-User Issues</h2><p>Because changes are being recorded in a single JSON file, there is an issue when more than one person is editing the data at the same time (last person to save would overwrite all changes).  We are not going to block this from happening but will warn a user that other people are in admin mode.  So for example, with tool-tips, if one person clicks on tool-tip admin mode, we will record their username in a BBWT3 database table and warn anyone else who clicks on the tool-tip admin mode checkbox if other people are also in admin mode and that data might be lost.</p><h2 id="BBWT3-SendingDatabacktoGitLab-GitLab">GitLab</h2><p>The GitLab service will take the function passed to it and call GitLab to get the name of the branch to create or update.</p><p>Once the user has edited the data and committed to the server, the process will create a merge request for the PM to accept.  If Blueberry staff edit the data themselves then they will need to submit the changes for merging using the same branch name convention.  If this does not happen, then merge conflicts may occur and there is a danger that changes could be overwritten.  If a developer deletes a control off a page, then there is a danger that a merge request could end up adding the information back into the JSON File, but this should be safe - will just add not used information.  The PM will control the merging so will be aware of changes being made.</p><p>Each project in GitLab has a project ID.  We will change the CI so that this value gets compiled into the project in the same way we currently use the build pipeline for the build version number.</p><p><br/></p><h2 id="BBWT3-SendingDatabacktoGitLab-ProcessComponents">Process Components</h2><h3 id="BBWT3-SendingDatabacktoGitLab-ClientAngularPage">Client Angular Page</h3><p>Every function will require a page in BBWT3 to allow users to administer the functionality.  The data edited will need to be sent to GitLab and so the page will need to work with a JSON file locally until the user is ready to submit their changes.  Clicking on the submit button will call a C# controller class as per normal MVC models.</p><p><br/></p><h3 id="BBWT3-SendingDatabacktoGitLab-FunctionController">Function Controller</h3><p>There will be a controller class for the data being edited.  This will receive the JSON file from the Angular page and pass it on to C# Service code to validate and process it.  The service code will send the data to the local BBWT3  database (either as JSON blob, e.g. for tool-tip, or as field data e.g. for DBSchema) and also send the JSON file to the BBWT3_Gitlab AWS Gateway service</p><p><br/></p><p>To call the BBWT3_Gitlab Service, the BBWT3 service code will read the:</p><ul><li>Project Name, Version and ID from the project fields (compiled in by GitLAb CI)</li><li>Username of logged in user (will be added to check-in comment)  <span style="color: rgb(255,0,0);">Note that this is always tricky, as most customers and testers use &quot;admin@&quot;.  I'll email on a solution later.</span></li><li>Gitlab Access key from Environment Variable on server</li><li>Hard coded Function Name (e.g. TOOLTIP)</li></ul><p><br/></p><h3 id="BBWT3-SendingDatabacktoGitLab-BBWT3_GitlabAmazonGatewayService">BBWT3_Gitlab Amazon Gateway Service</h3><p>We will need a Amazon Gateway service and associated Lambda function to be written.  This will need to:</p><ul><li>Create the branch name from the project name and the Function<ul><li>Function: TOOLTIP                        Branch Path: Feature/TOOLTIP</li><li>Function: DBDOCUMENT             Branch Path: Feature/DBDOCUMENT</li></ul></li></ul><p><br/></p><ul><li>Call GitLab Branches API (<a class="external-link" href="https://docs.gitlab.com/ee/api/branches.html" rel="nofollow">https://docs.gitlab.com/ee/api/branches.html</a>) using the Project ID to see if the branch already exists</li><li>If the branch already exists, the update that branch (GitLab will overlay the new changes on the file in the branch)</li><li>If the branch does not exist, create a new branch using received branch path (make it temporary so that it is automatically deleted after merge is accepted)</li><li>CallGitLab Commits API (<a class="external-link" href="https://docs.gitlab.com/ee/api/commits.html" rel="nofollow">https://docs.gitlab.com/ee/api/commits.html</a>) to commit file. The checkin comments will detail the DateTime - username of the person making the change.</li><li>Call GitLab Merge requests API (<a class="external-link" href="https://docs.gitlab.com/ee/api/merge_requests.html" rel="nofollow">https://docs.gitlab.com/ee/api/merge_requests.html</a>) to create a new merge request for created branch.</li></ul><p><br/></p><p>The code will need to validate the JSON object passed to it.  It should ensure it does not contain HTML tags or Script tags.</p>
                    </div>

                                        <div class="pageSection group">
                        <div class="pageSectionHeader">
                            <h2 id="attachments" class="pageSectionTitle">Attachments:</h2>
                        </div>

                        <div class="greybox" align="left">
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/85493343/85493344.png">GitLab WebService.PNG</a> (image/png)
                                <br/>
                                                    </div>
                    </div>
                    
                 
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on Nov 27, 2020 10:56</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
