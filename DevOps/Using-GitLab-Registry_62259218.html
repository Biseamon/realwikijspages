<!--
title: Using-GitLab-Registry_62259218
description: 
published: true
date: 2020-12-03T14:58:29.015Z
tags: 
editor: undefined
dateCreated: 2020-12-03T14:58:26.978Z
-->

<!DOCTYPE html>
<html>
    <head>
        <title>Blueberry : Using GitLab Registry</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">Blueberry</a></span>
                            </li>
                                                    <li>
                                <span><a href="DevOps-Information_36144018.html">DevOps Information</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            Blueberry : Using GitLab Registry
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
        
    
        
        
            Created by <span class='author'> Unknown User (ahk)</span>, last modified on Sep 04, 2018
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <p>GitLab has a feature where you can upload Docker images to be used by projects within GitLab.</p><h1 id="UsingGitLabRegistry-Usingtheregistryfromyourlocalmachine">Using the registry from your local machine</h1><p>First, ensure that you have a <a class="external-link" href="https://gitlab.bbconsult.co.uk/profile/personal_access_tokens" rel="nofollow">personal access token</a> created.</p><p>Note that this token will have access to registries on all projects you have access to, so don't use it in any build systems and keep it safe.</p><p>Next, you'll need to login. Start a shell, then run:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Midnight" data-theme="Midnight">docker login gitlab-registry.bbconsult.co.uk</pre>
</div></div><p>You can now build and push your images. Note that you only need to login before a push, not a build.</p><p>It's handy to alias this, so in your shell profile/rc:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Midnight" data-theme="Midnight">alias glr-login=&#39;echo personal-access-token | docker login -u gitlab-username --password-stdin https://gitlab-registry.bbconsult.co.uk&#39;</pre>
</div></div><p>You could take this a step further and store the personal access token in BitWarden, then fetch it via the BitWarden CLI.</p><p><span style="font-size: 20.0px;letter-spacing: 0.0px;">Building</span></p><p>Switch to the directory with your Dockerfile, then:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Midnight" data-theme="Midnight">docker build -t gitlab-registry.bbconsult.co.uk/group/project .</pre>
</div></div><p>or:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Midnight" data-theme="Midnight">docker build -t gitlab-registry.bbconsult.co.uk/group/project:tag .</pre>
</div></div><p>The '-t' switch tags at the same time as building.</p><p>You can then tag the same image with aliases. For example, if you wanted to build and tag the image as version 0.1 <em>and</em> latest, you could do this:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Midnight" data-theme="Midnight">docker build -t gitlab-registry.bbconsult.co.uk/group/project:0.1 -t gitlab-registry.bbconsult.co.uk/group/project:latest .</pre>
</div></div><p>You can also use the 'docker tag' command to retag at a later time if required.</p><h2 id="UsingGitLabRegistry-Pushing">Pushing</h2><p>Once you're happy with the build, you can then push the image with its tags.</p><p>You can push individual tags, or do a push on the image which will push all tags.</p><p>Pushing image and all tags:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Midnight" data-theme="Midnight">docker push gitlab-registry.bbconsult.co.uk/group/project</pre>
</div></div><p>Be aware that this will push <em>all</em> tags without discrimination, so if you have some tags you don't want to push you may want to push individual tags instead, like so:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Midnight" data-theme="Midnight">docker push gitlab-registry.bbconsult.co.uk/group/project:0.1</pre>
</div></div><p>This will only push the layers related to the '0.1' tag of the image.</p><p class="light">GitLab supports up to 3 levels of image names. The following examples of images are valid:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: text; gutter: false; theme: Midnight" data-theme="Midnight">gitlab-registry.bbconsult.co.uk/group/project:tag
gitlab-registry.bbconsult.co.uk/group/project/optional-image-name:tag
gitlab-registry.bbconsult.co.uk/group/project/optional-name/optional-image-name:tag</pre>
</div></div><h1 class="light" id="UsingGitLabRegistry-UsingtheregistrywithinGitLabCI">Using the registry within GitLab CI</h1><p>GitLab exposes the variable 'GITLAB_CI_TOKEN' within CI jobs for use with GitLab registry, to be paired with the built-in 'gitlab-ci-token' user. You need to use this to login before pushing tags in CI.</p><p>As GitLab uses Docker for running CI jobs, you need to use a special 'docker-in-docker' setup to be able to build in Docker.</p><p>Add the following to any job config in CI to set up docker in docker:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: yml; gutter: false; theme: Midnight" data-theme="Midnight">  services:
    - docker:dind</pre>
</div></div><p>You also need to set the registry URL to the project you're pushing to, like so:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: yml; gutter: false; theme: Midnight" data-theme="Midnight">variables:
  DOCKER_REGISTRY_URL: gitlab-registry.bbconsult.co.uk/group/project</pre>
</div></div><p>A complete but basic example would look like:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: yml; gutter: false; theme: Midnight" data-theme="Midnight">image: docker:latest


stages:
  - &#39;build&#39;


build:
  variables:
    DOCKER_REGISTRY_URL: gitlab-registry.bbconsult.co.uk/group/project
  stage: build
  services:
    - docker:dind
  script:
    - &#39;echo ${CI_JOB_TOKEN} | docker login -u gitlab-ci-token --password-stdin gitlab-registry.bbconsult.co.uk&#39;
    - &#39;docker build -t ${DOCKER_REGISTRY_URL}:latest .&#39;
    - &#39;docker push ${DOCKER_REGISTRY_URL}&#39;</pre>
</div></div><p>For a working example, see the <a class="external-link" href="https://gitlab.bbconsult.co.uk/blueberry/bbwt3-build/blob/master/.gitlab-ci.yml" rel="nofollow">bbwt3-build</a> project.</p>
                    </div>

                    
                 
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on Dec 03, 2020 14:51</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
