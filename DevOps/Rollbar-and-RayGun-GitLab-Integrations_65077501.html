<!DOCTYPE html>
<html>
    <head>
        <title>Blueberry : Rollbar and RayGun GitLab Integrations</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">Blueberry</a></span>
                            </li>
                                                    <li>
                                <span><a href="DevOps-Information_36144018.html">DevOps Information</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            Blueberry : Rollbar and RayGun GitLab Integrations
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
        
    
        
        
            Created by <span class='author'> Unknown User (ahk)</span>, last modified by <span class='editor'> Alex Putnam</span> on Aug 30, 2020
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <p>Blueberry use both Rollbar and RayGun to track user experience metrics and crashes. These tools can also be integrated with GitLab to upload source maps or notify the services when a new deployment occurs.</p><h1 id="RollbarandRayGunGitLabIntegrations-Rollbar">Rollbar</h1><p>Blueberry has been using Rollbar with Blueberry Web Template 3. So far, we have only used the front-end error tracking, and not the code integration, as the former was the only tool available when BBWT3 was being bootstrapped.</p><p>Your project should include the Rollbar scripts. This article won't go into detail on how to set that up, instructions are available on Rollbar's site e.g. <a class="external-link" href="https://rollbar.com/error-tracking/angular/" rel="nofollow">angular setup.</a></p><div class="confluence-information-macro confluence-information-macro-information"><span class="aui-icon aui-icon-small aui-iconfont-info confluence-information-macro-icon"></span><div class="confluence-information-macro-body"><p>See the BBWT3 project for a reference implementation.</p></div></div><p>For a BBWT3 project, the integration should already be included.</p><p>Rollbar is integrated with BBWT3 using these files:</p><ul><li>project/BBWT.Client/src/app/bbwt/modules/logging/rollbar.ts (project/BBWT.Client/src/app/utils/rollbar.ts in older BBWT3 projects) - Declares the Rollbar object for use in the project.</li><li>project/BBWT.Client/src/app/services/global-error-handler.ts - Registers Rollbar in the Angular global error handler.</li></ul><p>Once it's included, you then need to add or update the following GitLab CI variables:</p><ul><li>ROLLBAR_CLIENT_TOKEN - The Rollbar front-end token, included in the app.</li><li>ROLLBAR_SERVER_TOKEN - The Rollbar project token, allowing API access to Rollbar itself. This should never be included in the front-end. If it has, rotate it immediately.</li></ul><div class="confluence-information-macro confluence-information-macro-information"><span class="aui-icon aui-icon-small aui-iconfont-info confluence-information-macro-icon"></span><div class="confluence-information-macro-body"><p>Ask sysadmins for help with this if required. You might not have acces to the variables page or to the tokens themselves.</p></div></div><h2 id="RollbarandRayGunGitLabIntegrations-CI">CI</h2><p>The CI has three tasks to do regarding Rollbar:</p><ul><li>Substitute variables into the source files during build time</li><li>Upload source maps to Rollbar</li><li>Notify Rollbar of a new deployment</li></ul><p>If you're using a BBWT3 project, this should already be done. The following lines are sufficient to substitute the variables in. Make sure to update the values in angle brackets.</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: yml; gutter: false; theme: Midnight" data-theme="Midnight">- &#39;sed -i &quot;0,/__rollbar_flag__/s//true/&quot; project/BBWT.Client/src/app/utils/rollbar.ts&#39;
- &#39;sed -i &quot;s#__rollbar_environment__#&lt;YOUR ENVIRONMENT IN ROLLBAR&gt;#g&quot; project/BBWT.Client/src/app/utils/rollbar.ts&#39;
- &#39;sed -i &quot;s#__rollbar_server_token__#${ROLLBAR_SERVER_TOKEN}#g&quot; project/BBWT.Client/webpack.config.js&#39;
- &#39;sed -i &quot;s#__rollbar_client_token__#${ROLLBAR_CLIENT_TOKEN}#g&quot; project/BBWT.Client/src/app/utils/rollbar.ts&#39;
- &#39;sed -i &quot;s#__rollbar_source_map_version__#${CI_COMMIT_SHA}#g&quot; project/BBWT.Client/src/app/utils/rollbar.ts project/BBWT.Client/webpack.config.js&#39;
- &#39;sed -i &quot;s#__rollbar_public_path__#&lt;YOUR WEBSITE URL&gt;/dist#g&quot; project/BBWT.Client/webpack.config.js&#39;</pre>
</div></div><p>Uploading source maps are achieved using the following lines during build job, after the project is built:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: yml; gutter: false; theme: Midnight" data-theme="Midnight">- &#39;curl https://api.rollbar.com/api/1/sourcemap -F access_token=${ROLLBAR_ACCESS_TOKEN} -F version=${CI_COMMIT_SHA} -F minified_url=&lt;YOUR WEBSITE URL&gt;/dist/app.js -F source_map=@build/wwwroot/dist/app.js.map&#39;
- &#39;curl https://api.rollbar.com/api/1/sourcemap -F access_token=${ROLLBAR_ACCESS_TOKEN} -F version=${CI_COMMIT_SHA} -F minified_url=&lt;YOUR WEBSITE URL&gt;/dist/account.js -F source_map=@build/wwwroot/dist/account.js.map&#39;
- &#39;curl https://api.rollbar.com/api/1/sourcemap -F access_token=${ROLLBAR_ACCESS_TOKEN} -F version=${CI_COMMIT_SHA} -F minified_url=&lt;YOUR WEBSITE URL&gt;/dist/vendor.js -F source_map=@build/wwwroot/dist/vendor.js.map&#39;</pre>
</div></div><p>Adjust the source map URLs as required.</p><p>The following line should be included after the software is successfully deployed:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: yml; gutter: false; theme: Midnight" data-theme="Midnight">- &#39;curl https://api.rollbar.com/api/1/deploy/ -F access_token=${ROLLBAR_SERVER_TOKEN} -F environment=&lt;YOUR ROLLBAR ENVIRONMENT&gt; -F revision=${CI_COMMIT_SHA} -F local_username=&quot;${GITLAB_USER_NAME} (${GITLAB_USER_LOGIN})&quot;&#39;</pre>
</div></div><p>This notifies Rollbar of the deployment, making it easier to track.</p><h1 id="RollbarandRayGunGitLabIntegrations-Raygun">Raygun</h1><p>There are multiple ways to integrate RayGun with your project:</p><ul><li>Frontend<br/><ul><li><a class="external-link" href="https://raygun.com/languages/javascript/angular" rel="nofollow">Angular</a></li><li><a class="external-link" href="https://raygun.com/languages/javascript" rel="nofollow">Javascript</a></li></ul></li><li>Application Performance Monitoring<ul><li><a class="external-link" href="https://raygun.com/documentation/product-guides/apm/agent/downloads/" rel="nofollow">APM agent</a></li></ul></li><li>Code<ul><li><a class="external-link" href="https://raygun.com/docs/languages/net" rel="nofollow">Raygun4Net</a></li></ul></li></ul><p>Blueberry Web Template can make full use of all of the Raygun platform.</p><div class="confluence-information-macro confluence-information-macro-information"><span class="aui-icon aui-icon-small aui-iconfont-info confluence-information-macro-icon"></span><div class="confluence-information-macro-body"><p>See the BBWT3 project for a reference implementation.</p></div></div><p>Raygun is integrated with BBWT3 using these files:</p><div id="expander-1069514214" class="expand-container"><div id="expander-control-1069514214" class="expand-control"><span class="expand-control-icon"><img style="vertical-align:middle;" class="expand-control-image" src="images/icons/grey_arrow_down.png"></span><span class="expand-control-text">For newer versions of BBWT3</span></div><div id="expander-content-1069514214" class="expand-content"><ul><li>project/BBWT.Client/src/app/bbwt/modules/logging/raygun.ts</li><li>project/BBWT.Client/src/app/bbwt/modules/logging/global-error.handler.ts</li></ul></div></div><div id="expander-1302565621" class="expand-container"><div id="expander-control-1302565621" class="expand-control"><span class="expand-control-icon"><img style="vertical-align:middle;" class="expand-control-image" src="images/icons/grey_arrow_down.png"></span><span class="expand-control-text">For older versions of BBWT3</span></div><div id="expander-content-1302565621" class="expand-content"><ul><li>project/BBWT.Server/Views/Shared/_Layout.cshtml - Javascript snippet included here async, as recommended by Raygun themselves.</li><li><span>project/BBWT.Client/src</span>/app/utils/raygun.ts - Provides a Typescript hook to the above snippet object.</li><li>project/BBWT.Client/src/app/handlers/global-error-handler.ts - Registers Raygun in the Angular global error handler.</li></ul></div></div><p>Once RayGun has been added to the project, the following variables should be defined in the CI variables for the project:</p><ul><li>RAYGUN_API_KEY - Included in the front-end. You may wish to create multiples of these with different suffixes if you have multiple environments.</li><li>RAYGUN_API_TOKEN - API access to RayGun, should not be included in front-end. Rotate immediately if leaked.</li></ul><div class="confluence-information-macro confluence-information-macro-information"><span class="aui-icon aui-icon-small aui-iconfont-info confluence-information-macro-icon"></span><div class="confluence-information-macro-body"><p>Ask sysadmins for help with this if required. You might not have acces to the variables page or to the tokens themselves.</p></div></div><p>Raygun also provide a <a class="external-link" href="https://raygun.com/docs/deployments/bash" rel="nofollow">convenience script</a> for notifying them of deployments. This should be included in the repository as 'raygun.sh', ideally in the top-level 'scripts' directory.</p><h2 id="RollbarandRayGunGitLabIntegrations-CI.1">CI</h2><p>CI has two tasks to do regarding RayGun:</p><ul><li>Substitute variables into the source files during build time</li><li>Notify Raygun of a new deployment</li></ul><p>The following lines should be included after the project has been built, in the deploy job for a particular environment:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: yml; gutter: false; theme: Midnight" data-theme="Midnight">- &#39;sed -i &quot;0,/__raygun_flag__/s//true/&quot; build/wwwroot/dist/bbwt.js&#39;
- &#39;sed -i &quot;s#__raygun_version__#${CI_COMMIT_SHA}#g&quot; build/wwwroot/dist/bbwt.js&#39;
- &#39;sed -i &quot;s#__raygun_api_key__#${RAYGUN_API_KEY}#g&quot; build/wwwroot/dist/bbwt.js&#39;</pre>
</div></div><p>You may need to abstract these variables if you have multiple environments. See the BBWT3 project's CI as an example.</p><p>Those lines are added in the built project to support projects which deploy to multiple environments, as Raygun does not have the ability to include the running environment name on the front-end like Rollbar.</p><p>The following line should be run after a successful deploy and notifies Raygun of the deployment:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: yml; gutter: false; theme: Midnight" data-theme="Midnight">- &#39;scripts/raygun.sh -v ${CI_COMMIT_SHA} -a ${RAYGUN_API_KEY} -t ${RAYGUN_API_TOKEN} -g ${CI_COMMIT_SHA} -e ${GITLAB_USER_EMAIL} -n ${GITLAB_USER_NAME}&#39;</pre>
</div></div><p class="auto-cursor-target">See the BBWT3 project for a copy of the raygun.sh script if your project does not include it.</p><h2 id="RollbarandRayGunGitLabIntegrations-InstallingandintegratingtheAPMagent">Installing and integrating the APM agent</h2><p>To install the APM agent, download the latest installer from <a class="external-link" href="https://raygun.com/documentation/product-guides/apm/agent/downloads/" rel="nofollow">this page</a>.</p><p>If installing interactively, install as normal and then open the Raygun profiler configuration utility. Register the API key of the project on the agent tab, and then switch to either the IIS tab (BBWT2/other applications), or the .NET Core tab (BBWT3) and register the relevant application.</p><p>In the CI, you will need to run a post installation script to register the Raygun profiler. If you're using the SSH deployment method, create or update the scripts/win-postinstall.ps1 file in the repository with the following contents:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: powershell; gutter: false; theme: Midnight" data-theme="Midnight">if ($PSHOME -like &quot;*SysWOW64*&quot;) {
    Write-Warning &quot;Restarting this script under 64-bit Windows PowerShell.&quot;
    # Restart this script under 64-bit Windows PowerShell.
    &amp; (Join-Path ($PSHOME -replace &quot;SysWOW64&quot;, &quot;SysNative&quot;) powershell.exe) -File (Join-Path $PSScriptRoot $MyInvocation.MyCommand) @args
    # Exit 32-bit script, pass error code to deployment agent.
    Exit $LastExitCode
}


$appCmd = (Join-Path -Path $Env:windir -ChildPath &quot;system32\inetsrv\appcmd.exe&quot;)
$rgcli = &quot;${env:Programfiles(x86)}\Raygun\RaygunAgent\rgc.exe&quot;
$IISWebSite = &quot;bbwt3-app&quot;
$IISAppPool = &quot;bbwt3-app&quot;
$raygunProfilerx86RootPath = (Join-Path -Path ${env:Programfiles(x86)} -ChildPath &quot;Raygun&quot; | Join-Path -ChildPath &quot;RaygunProfiler&quot;)
$raygunProfilerx64RootPath = (Join-Path -Path ${env:Programfiles} -ChildPath &quot;Raygun&quot; | Join-Path -ChildPath &quot;RaygunProfiler&quot;)
$raygunProfilerCurrentVersionx86Path = (Join-Path -Path $raygunProfilerx86RootPath (Get-ChildItem $raygunProfilerx86RootPath -Directory | Sort-Object LastWriteTime | Select-Object -Last 1))
$raygunProfilerCurrentVersionx64Path = (Join-Path -Path $raygunProfilerx64RootPath (Get-ChildItem $raygunProfilerx64RootPath -Directory | Sort-Object LastWriteTime | Select-Object -Last 1))


# Raygun setup
&amp; $rgcli -register __raygun_api_key__
&amp; $rgcli -enable BBWT.Web.dll -type dotnetcore -apikey __raygun_api_key__ -startup 30 -norecycle
&amp; $appCmd set config &quot;$IISWebSite&quot; -section:system.webServer/aspNetCore /+&quot;environmentVariables.[name=&#39;CORECLR_ENABLE_PROFILING&#39;,value=&#39;1&#39;]&quot; /commit:site
&amp; $appCmd set config &quot;$IISWebSite&quot; -section:system.webServer/aspNetCore /+&quot;environmentVariables.[name=&#39;CORECLR_PROFILER&#39;,value=&#39;{e2338988-38cc-48cd-a6b6-b441c31f34f1}&#39;]&quot; /commit:site
&amp; $appCmd set config &quot;$IISWebSite&quot; -section:system.webServer/aspNetCore /+&quot;environmentVariables.[name=&#39;CORECLR_PROFILER_PATH_32&#39;,value=&#39;$raygunProfilerCurrentVersionx86Path\x86\RaygunProfiler.dll&#39;]&quot; /commit:site
&amp; $appCmd set config &quot;$IISWebSite&quot; -section:system.webServer/aspNetCore /+&quot;environmentVariables.[name=&#39;CORECLR_PROFILER_PATH_64&#39;,value=&#39;$raygunProfilerCurrentVersionx64Path\x64\RaygunProfiler.dll&#39;]&quot; /commit:site
&amp; $appCmd set config &quot;$IISWebSite&quot; -section:system.webServer/aspNetCore /+&quot;environmentVariables.[name=&#39;COMPLUS_ProfAPI_ProfilerCompatibilitySetting&#39;,value=&#39;EnableV2Profiler&#39;]&quot; /commit:site
&amp; $appCmd set config &quot;$IISWebSite&quot; -section:system.webServer/aspNetCore /+&quot;environmentVariables.[name=&#39;PROTON_STARTUP_PERIOD&#39;,value=&#39;60&#39;]&quot; /commit:site</pre>
</div></div><p>This script ensures that the profiler configuration is using the latest version installed on the server and writes this to the web.config of the application.</p><p>Update the $IISWebSite and $IISAppPool variables as necessary.</p><p>In your CI, ensure that you substitute the __raygun_api_key__ above using sed, e.g.:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: csharp; gutter: false; theme: Midnight" data-theme="Midnight">script:
 - &#39;sed -i &quot;s#__raygun_api_key__#${RAYGUN_API_KEY_TEST}#g&quot; scripts/win-postinstall.ps1&#39;</pre>
</div></div><p>Then make sure that your ssh command includes a call to the script, e.g.:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: csharp; gutter: false; theme: Midnight" data-theme="Midnight">script:
 - &#39;ssh -i ${HOME}/ssh.key -o StrictHostKeyChecking=no -p ${SERVER_PORT_LIVE_WIN} -l ${SERVER_USER_LIVE_WIN} ${SERVER_IP_LIVE_WIN} &quot;cd C:/deploy &amp;&amp; app-deploy.bat ${CI_COMMIT_SHA} &amp;&amp; powershell -File win-postinstall.ps1&quot;&#39;</pre>
</div></div><h2 id="RollbarandRayGunGitLabIntegrations-IntegratingRaygun4Net">Integrating Raygun4Net</h2><p>Ensure the <a class="external-link" href="https://www.nuget.org/packages/Mindscape.Raygun4Net/" rel="nofollow">Raygun4Net nuget package</a> has been added to the web project, and that the <a class="external-link" href="https://raygun.com/documentation/language-guides/dotnet/crash-reporting/aspnetcore/" rel="nofollow">necessary code changes</a> have been made. This should already be done if you are using a recent version of BBWT3.</p><p>In the appsettings.$environment.json file for your project, add the following top-level key:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: csharp; gutter: false; theme: Midnight" data-theme="Midnight">&quot;RaygunSettings&quot;: {
  &quot;ApiKey&quot;: &quot;API_KEY&quot;
  &quot;ApplicatonVersion&quot;: &quot;APP_VERSION&quot;
}</pre>
</div></div><p>Substitute API_KEY for the project's api key, and APP_VERSION for an application version identifier, e.g. the commit hash. For an example of these variables being substituted during CI, see <a class="external-link" href="https://gitlab.bbconsult.co.uk/hudson/freepay/blob/test/.gitlab-ci.yml#L287" rel="nofollow">here</a>.</p><p><br/></p><div class="jfk-bubble gtx-bubble" />
                    </div>

                    
                 
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on Dec 03, 2020 14:51</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
